name: CI - Tests and Linting

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  backend-tests:
    name: Backend Tests & Coverage
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [20.x]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: functions/package-lock.json

      - name: Install backend dependencies
        working-directory: ./functions
        run: npm ci

      - name: Run ESLint
        working-directory: ./functions
        run: npm run lint
        continue-on-error: true

      - name: Run unit tests
        working-directory: ./functions
        run: npm run test:unit

      - name: Run integration tests
        working-directory: ./functions
        run: npm run test:integration
        continue-on-error: true

      - name: Generate coverage report
        working-directory: ./functions
        run: npm run test:unit -- --coverage
        continue-on-error: true

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          directory: ./functions/coverage
          flags: backend
          name: backend-coverage
        continue-on-error: true

  frontend-tests:
    name: Frontend Tests & Build
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [20.x]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Run ESLint
        working-directory: ./frontend
        run: npm run lint
        continue-on-error: true

      - name: Run frontend tests
        working-directory: ./frontend
        run: npm run test:run
        continue-on-error: true

      - name: Build frontend
        working-directory: ./frontend
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL || 'http://localhost:5001/proyecto-arqui-2c418/us-central1/api' }}
        run: npm run build

      - name: Upload frontend build artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist
          retention-days: 7

  security-scan:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Audit backend dependencies
        working-directory: ./functions
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: Audit frontend dependencies
        working-directory: ./frontend
        run: npm audit --audit-level=moderate
        continue-on-error: true

  sonarqube:
    name: SonarQube Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for better analysis

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Install backend dependencies
        working-directory: ./functions
        run: npm ci

      - name: Run frontend tests with coverage
        working-directory: ./frontend
        run: npm run test:coverage
        continue-on-error: true

      - name: Run backend tests with coverage
        working-directory: ./functions
        run: npm run test:unit -- --coverage
        continue-on-error: true

      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarcloud.io

      - name: SonarQube Quality Gate
        uses: SonarSource/sonarqube-quality-gate-action@master
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        continue-on-error: true  # No fallar el pipeline por Quality Gate (para desarrollo)

  secrets-scan:
    name: Secrets Scanning (Gitleaks)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
        continue-on-error: true

  container-scan:
    name: Container Scanning (Trivy)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build frontend Docker image
        working-directory: ./frontend
        run: docker build -t monis-frontend:latest .

      - name: Build backend Docker image
        working-directory: ./functions
        run: docker build -t monis-backend:latest .

      - name: Run Trivy vulnerability scanner on frontend
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'monis-frontend:latest'
          format: 'sarif'
          output: 'trivy-frontend-results.sarif'
          severity: 'CRITICAL,HIGH'
        continue-on-error: true

      - name: Run Trivy vulnerability scanner on backend
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'monis-backend:latest'
          format: 'sarif'
          output: 'trivy-backend-results.sarif'
          severity: 'CRITICAL,HIGH'
        continue-on-error: true

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: '.'
        continue-on-error: true

  dast-scan:
    name: DAST Scanning (OWASP ZAP)
    runs-on: ubuntu-latest
    needs: [frontend-tests]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Download frontend build artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Start frontend preview server
        working-directory: ./frontend
        run: |
          npm run preview &
          echo $! > .preview-pid
          sleep 10
        
      - name: Wait for server to be ready
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:4173; do sleep 2; done' || exit 1

      - name: Run OWASP ZAP Baseline Scan
        run: |
          docker run --rm \
            -v ${{ github.workspace }}/security:/zap/wrk/ \
            --network host \
            softwaresecurityproject/zap-stable \
            zap-baseline.py \
            -t http://localhost:4173 \
            -r zap-baseline-report.html \
            -J zap-baseline-report.json \
            -w zap-baseline-report.md \
            -l WARN
        continue-on-error: true

      - name: Stop preview server
        if: always()
        working-directory: ./frontend
        run: |
          if [ -f .preview-pid ]; then
            kill $(cat .preview-pid) || true
          fi

      - name: Upload ZAP reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-reports
          path: |
            security/zap-baseline-report.html
            security/zap-baseline-report.json
            security/zap-baseline-report.md
          retention-days: 30

      - name: Comment ZAP Results on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const zapMd = fs.readFileSync('security/zap-baseline-report.md', 'utf8');
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## üîí OWASP ZAP DAST Scan Results\n\n${zapMd}\n\n[View full HTML report](${context.payload.repository.html_url}/actions/runs/${context.runId})`
              });
            } catch (error) {
              console.log('Could not post ZAP results:', error);
            }
        continue-on-error: true

  allure-report:
    name: Generate Allure Report
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install backend dependencies
        working-directory: ./functions
        run: npm ci

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Run backend tests with Allure
        working-directory: ./functions
        run: npm run test:unit
        continue-on-error: true

      - name: Run frontend tests with Allure
        working-directory: ./frontend
        run: npm run test:run
        continue-on-error: true

      - name: Install Allure
        run: npm install -g allure-commandline

      - name: Generate Allure Report
        if: always()
        run: |
          mkdir -p allure/allure-report
          allure generate allure/allure-results --clean -o allure/allure-report || echo "Warning: Allure generation had issues"

      - name: Upload Allure Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure/allure-report
          retention-days: 30

      - name: Upload Allure Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results
          path: allure/allure-results
          retention-days: 7

  build-status:
    name: Build Status Check
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, security-scan, sonarqube, secrets-scan, container-scan, dast-scan, allure-report]
    if: always()
    
    steps:
      - name: Check build status
        run: |
          if [ "${{ needs.backend-tests.result }}" != "success" ] || [ "${{ needs.frontend-tests.result }}" != "success" ]; then
            echo "‚ùå One or more jobs failed"
            exit 1
          else
            echo "‚úÖ All jobs passed successfully"
          fi
